<!DOCTYPE html>
<!--
    VERDEX Soil Prediction System - Web Dashboard
    
    Interactive web interface for soil parameter forecasting using LSTM models.
    Features:
    - Real-time predictions for N, P, Moisture, pH
    - Historical data visualization with Chart.js
    - Model status monitoring
    - API documentation
    - Supabase integration
    
    Version: 3.0
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Prediction System - API Guide & Dashboard</title>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- ==================== STYLES ==================== -->
    <style>
        /* ==================== GLOBAL RESET ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ==================== BODY & LAYOUT ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ==================== HEADER STYLES ==================== */
        header {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .card h3 {
            color: #333;
            margin: 15px 0 10px 0;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input[type="file"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="file"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #764ba2;
        }

        .button-secondary:hover {
            background: #653a8a;
        }

        .status-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .status-value {
            color: #667eea;
            font-weight: 600;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .prediction-card {
            background: #f9f9f9;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
        }

        .prediction-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .current-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .forecast-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .forecast-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 0.85em;
        }

        .forecast-value {
            font-weight: bold;
            color: #667eea;
        }

        .stats-table {
            width: 100%;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .stats-table tr {
            border-bottom: 1px solid #eee;
        }

        .stats-table td {
            padding: 5px;
        }

        .stats-table td:last-child {
            color: #667eea;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            position: relative;
            height: 300px;
        }

        .api-docs {
            background: white;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.6;
            color: #333;
        }

        .api-endpoint {
            background: #f5f5f5;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .api-method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 10px;
            color: white;
        }

        .api-method.get { background: #4CAF50; }
        .api-method.post { background: #2196F3; }

        .code-block {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin: 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .predictions-grid {
                grid-template-columns: 1fr;
            }
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ==================== HEADER SECTION ==================== -->
        <header>
            <h1>üå± Soil Prediction System</h1>
            <p>AI-Powered Time Series Forecasting for Soil Parameters</p>
            <div class="status-badge" id="statusBadge">Loading...</div>
        </header>

        <!-- ==================== MAIN LAYOUT ==================== -->
        <div class="main-layout">
            <!-- LEFT SIDEBAR: Controls and Status -->
            <div class="sidebar">
                <!-- Data Sync Card -->
                <div class="card">
                    <h2>üìÇ Sync Data</h2>
                    <div class="form-group">
                        <label>Fetch from Supabase:</label>
                        <small style="color: #999;">Auto-syncs latest data from raw_sensor_readings table</small>
                    </div>
                    <button onclick="syncData()">üîÑ Sync from Supabase</button>
                </div>

                <!-- Action Buttons Card -->
                <div class="card">
                    <h2>‚öôÔ∏è Actions</h2>
                    <button onclick="makePrediction()">üîÆ Make Prediction</button>
                    <button class="button-secondary" onclick="loadModelsStatus()">üìä Check Models</button>
                    <button class="button-secondary" onclick="getDataInfo()">üìà Data Statistics</button>
                </div>

                <!-- Model Status Display -->
                <div class="card">
                    <h2>ü§ñ Model Status</h2>
                    <div id="modelStatus" class="status-section">
                        <div class="status-item">
                            <strong>Models Loaded:</strong>
                            <span class="status-value" id="modelsLoaded">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Status:</strong>
                            <span class="status-value" id="appStatus">--</span>
                        </div>
                        <!-- Dynamic model list populated by JS -->
                        <div id="modelsList" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Data Statistics Card -->
                <div class="card">
                    <h2>üìä Data Info</h2>
                    <div id="dataInfo" class="status-section">
                        <p style="color: #999; font-size: 0.9em;">Upload a CSV file to see statistics</p>
                    </div>
                </div>
            </div>

            <!-- RIGHT MAIN CONTENT AREA -->
            <div class="main-content">
                <!-- Alert/Message Container -->
                <div id="alertContainer"></div>

                <!-- Tab Navigation -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('predictions')">üéØ Predictions</button>
                    <button class="tab-btn" onclick="switchTab('charts')">üìä Charts</button>
                    <button class="tab-btn" onclick="switchTab('api')">üîå API Docs</button>
                </div>

                <!-- TAB 1: Predictions Display -->
                <div id="predictions" class="tab-content card active">
                    <h2>üîÆ Forecast Results</h2>
                    <p style="color: #999; margin-bottom: 15px;">Upload data and click "Make Prediction" to see forecasts</p>
                    <!-- Dynamic prediction cards populated by JS -->
                    <div id="predictionsContainer" class="predictions-grid"></div>
                </div>

                <!-- TAB 2: Charts and Visualization -->
                <div id="charts" class="tab-content card">
                    <h2>üìä Historical Data Visualization</h2>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="parameterSelect">Select Parameter:</label>
                        <select id="parameterSelect" onchange="loadChart()">
                            <option value="nitrogen">Nitrogen (N)</option>
                            <option value="phosphorus">Phosphorus (P)</option>
                            <option value="moisture">Soil Moisture (K)</option>
                            <option value="pH">Soil pH</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>

                <!-- TAB 3: API Documentation -->
                <div id="api" class="tab-content card">
                    <h2>üîå API Documentation</h2>
                    <div class="api-docs">
                        <h3>Overview</h3>
                        <p>Pre-trained LSTM models for soil nutrients and moisture prediction using Supabase data.</p>
                        <p><strong>Data Source:</strong> <code>raw_sensor_readings</code> table (Supabase)</p>

                        <h3 style="margin-top: 20px;">Endpoints</h3>

                        <div class="api-endpoint">
                            <strong><span class="api-method get">GET</span> /api/health</strong>
                            <p>Health check and connection status</p>
                            <div class="code-block">curl "http://localhost:5000/api/health"</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method post">POST</span> /api/upload</strong>
                            <p>Sync latest data from Supabase raw_sensor_readings table</p>
                            <div class="code-block">curl -X POST http://localhost:5000/api/upload</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method post">POST</span> /api/predict</strong>
                            <p>Make predictions using latest Supabase data (10-step forecast)</p>
                            <div class="code-block">curl -X POST http://localhost:5000/api/predict</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method get">GET</span> /api/historical</strong>
                            <p>Get historical data from Supabase (parameter: nitrogen|phosphorus|moisture|pH, limit: default 100)</p>
                            <div class="code-block">curl "http://localhost:5000/api/historical?parameter=nitrogen&limit=100"</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method get">GET</span> /api/data-info</strong>
                            <p>Get statistics of current Supabase data</p>
                            <div class="code-block">curl "http://localhost:5000/api/data-info"</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method get">GET</span> /api/model-status</strong>
                            <p>Get status of all models</p>
                            <div class="code-block">curl "http://localhost:5000/api/model-status"</div>
                        </div>

                        <div class="api-endpoint">
                            <strong><span class="api-method get">GET</span> /api/docs</strong>
                            <p>Get this API documentation as JSON</p>
                            <div class="code-block">curl "http://localhost:5000/api/docs"</div>
                        </div>

                        <h3 style="margin-top: 20px;">Environment Variables</h3>
                        <p>Configure Supabase connection:</p>
                        <div class="code-block">SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-api-key</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== FOOTER ==================== -->
        <div class="footer">
            <p>üí® Powered by Pre-trained LSTM Models | Version 2.1</p>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // Global chart instance (destroyed/recreated when switching parameters)
        let currentChart = null;

        /**
         * Initialize page on DOM load
         * - Perform initial health check
         * - Load model status
         * - Set up periodic health checks (every 5 seconds)
         */
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            loadModelsStatus();
            setInterval(checkHealth, 5000);  // Poll health every 5 seconds
        });

        /**
         * Switch between dashboard tabs (Predictions, Charts, API Docs)
         * @param {string} tabName - Tab identifier (predictions|charts|api)
         */
        function switchTab(tabName) {
            // Remove active class from all tabs and buttons
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Activate selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load chart if switching to charts tab (slight delay for rendering)
            if (tabName === 'charts') {
                setTimeout(loadChart, 100);
            }
        }

        /**
         * Check application health status
         * Updates status badge based on model availability
         */
        function checkHealth() {
            fetch('/api/health')
                .then(r => {
                    if (!r.ok) throw new Error('Health check failed');
                    return r.json();
                })
                .then(data => {
                    const badge = document.getElementById('statusBadge');
                    if (data.models_loaded && data.models_loaded > 0) {
                        badge.textContent = `‚úÖ Ready (${data.models_loaded}/4 Models)`;
                    } else {
                        badge.textContent = '‚ö†Ô∏è Degraded';
                    }
                })
                .catch(() => {
                    document.getElementById('statusBadge').textContent = '‚ùå Connection Error';
                });
        }

        /**
         * Sync sensor data from Supabase database
         * Fetches latest readings and updates local cache
         */
        function syncData() {
            showAlert('üîÑ Syncing data from Supabase...', 'info');
            
            fetch('/api/upload', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`‚úÖ ${data.message}`, 'success');
                        getDataInfo();  // Refresh statistics
                        loadModelsStatus();  // Update model status
                    } else {
                        showAlert(`‚ùå Sync failed: ${data.error}`, 'error');
                    }
                })
                .catch(err => showAlert(`‚ùå Error: ${err.message}`, 'error'));
        }

        /**
         * Generate predictions for all soil parameters
         * Calls backend API and displays forecast results
         */
        function makePrediction() {
            showAlert('üîÆ Making predictions...', 'info');
            fetch('/api/predict', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        displayPredictions(data.predictions);
                        showAlert('‚úÖ Predictions complete! (Forecast: 10 steps ahead)', 'success');
                    } else {
                        showAlert(`‚ùå ${data.error || 'Prediction failed'}`, 'error');
                    }
                })
                .catch(err => showAlert(`‚ùå Error: ${err.message}`, 'error'));
        }

        /**
         * Load and display status of all LSTM models
         * Shows which models are loaded and their metadata
         */
        function loadModelsStatus() {
            fetch('/api/model-status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('modelsLoaded').textContent = `${data.loaded_models}/${data.total_models}`;
                    document.getElementById('appStatus').textContent = data.loaded_models === data.total_models ? '‚úÖ Ready' : `‚ö†Ô∏è ${data.loaded_models}/${data.total_models}`;
                    
                    const modelsList = document.getElementById('modelsList');
                    modelsList.innerHTML = '';
                    
                    for (let [param, info] of Object.entries(data.models)) {
                        const status = info.status === 'loaded' ? '‚úÖ' : '‚ùå';
                        modelsList.innerHTML += `
                            <div style="padding: 8px 0; font-size: 0.85em; border-bottom: 1px solid #eee;">
                                <strong>${status} ${param.toUpperCase()}</strong><br>
                                <small style="color: #999;">${info.model_file || 'N/A'}</small>
                            </div>
                        `;
                    }
                    showAlert('‚úÖ Models loaded: ' + data.loaded_models + '/' + data.total_models, 'info');
                })
                .catch(err => {
                    showAlert('‚ùå Failed to check models', 'error');
                });
        }

        /**
         * Fetch and display data statistics from Supabase
         * Shows mean, current values, and data point count
         */
        function getDataInfo() {
            fetch('/api/data-info')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.statistics;
                        let html = `<div style="font-size: 0.85em;">
                            <div class="status-item">
                                <strong>üìä Data Points:</strong>
                                <span class="status-value">${data.total_rows}</span>
                            </div>`;
                        
                        for (let [param, stat] of Object.entries(stats)) {
                            html += `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">
                                    <strong>${stat.display_name}</strong><br>
                                    <small>üìà Mean: ${stat.mean} | üìç Current: ${stat.current}</small>
                                </div>
                            `;
                        }
                        html += '</div>';
                        document.getElementById('dataInfo').innerHTML = html;
                        showAlert('‚úÖ Data loaded: ' + data.total_rows + ' rows', 'success');
                    } else {
                        document.getElementById('dataInfo').innerHTML = '<p style="color: #999; font-size: 0.9em;">‚ùå ' + data.error + '</p>';
                    }
                })
                .catch(err => {
                    document.getElementById('dataInfo').innerHTML = '<p style="color: #999; font-size: 0.9em;">‚ùå Error loading data</p>';
                });
        }

        /**
         * Load historical data chart for selected parameter
         * Fetches data from API and renders using Chart.js
         */
        function loadChart() {
            const param = document.getElementById('parameterSelect').value;
            
            fetch(`/api/historical?parameter=${param}&limit=100`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.values && data.values.length > 0) {
                        renderChart(data.display_name, data.values, data.indices);
                    } else {
                        showAlert('‚ö†Ô∏è No historical data available', 'info');
                    }
                })
                .catch(err => showAlert(`‚ùå Failed to load chart: ${err.message}`, 'error'));
        }

        /**
         * Render time series chart using Chart.js
         * @param {string} title - Chart title (parameter display name)
         * @param {Array<number>} values - Data values to plot
         * @param {Array<number>} indices - X-axis indices (time points)
         */
        function renderChart(title, values, indices) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: indices,
                    datasets: [{
                        label: title,
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { ticks: { color: '#999' } },
                        x: { ticks: { color: '#999' } }
                    }
                }
            });
        }

        /**
         * Display prediction results in card grid format
         * @param {Object} predictions - Prediction data from API
         */
        function displayPredictions(predictions) {
            const container = document.getElementById('predictionsContainer');
            container.innerHTML = '';
            
            const params = ['nitrogen', 'phosphorus', 'moisture', 'pH'];
            const paramNames = {
                'nitrogen': 'üåæ Nitrogen',
                'phosphorus': 'üü† Phosphorus',
                'moisture': 'üíß Soil Moisture',
                'pH': 'üß™ pH Level'
            };

            for (let param of params) {
                const pred = predictions[param];
                if (!pred || pred.error) continue;

                let html = `
                    <div class="prediction-card">
                        <h4>${paramNames[param]}</h4>
                        <div class="current-value">${pred.current_value}</div>
                        
                        <strong style="font-size: 0.9em;">10-Step Forecast:</strong>
                        <div class="forecast-row">
                `;
                
                pred.forecast.forEach((val, idx) => {
                    html += `
                        <div class="forecast-item">
                            <div style="font-size: 0.75em; color: #999;">S${idx + 1}</div>
                            <div class="forecast-value">${val}</div>
                        </div>
                    `;
                });
                
                html += `</div>
                    <table class="stats-table">
                        <tr><td>Mean</td><td>${pred.statistics.mean}</td></tr>
                        <tr><td>Min</td><td>${pred.statistics.min}</td></tr>
                        <tr><td>Max</td><td>${pred.statistics.max}</td></tr>
                        <tr><td>Trend</td><td>${pred.statistics.trend}</td></tr>
                    </table>
                    </div>
                `;
                
                container.innerHTML += html;
            }
        }

        /**
         * Display alert message to user
         * @param {string} message - Message text to display
         * @param {string} type - Alert type (success|error|info)
         */
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-dismiss after 3 seconds (except errors)
            if (type !== 'error') {
                setTimeout(() => alert.remove(), 3000);
            }
        }
    </script>
</body>
</html>
